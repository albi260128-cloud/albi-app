<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íœ´ëŒ€í° ë³¸ì¸ì¸ì¦ - ì•Œë¹„</title>
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Pretendard', sans-serif;
      background: #f8f9fa;
      padding: 20px;
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .logo {
      font-size: 28px;
      font-weight: 700;
      color: #FF6B35;
      margin-bottom: 8px;
    }
    
    h1 {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .subtitle {
      font-size: 14px;
      color: #666;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #FF6B35;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }
    
    select.form-input {
      cursor: pointer;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #FF6B35;
      color: white;
      margin-bottom: 10px;
    }
    
    .btn-primary:hover {
      background: #E55A2B;
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #10B981;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #059669;
    }
    
    .verification-options {
      display: none;
      margin-top: 20px;
    }
    
    .option-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .option-card:hover {
      border-color: #FF6B35;
      background: #fff5f2;
    }
    
    .option-card.selected {
      border-color: #FF6B35;
      background: #fff5f2;
    }
    
    .option-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    
    .option-desc {
      font-size: 13px;
      color: #666;
    }
    
    .info-box {
      background: #f0f9ff;
      border: 1px solid #bfdbfe;
      border-radius: 6px;
      padding: 12px;
      margin-top: 20px;
    }
    
    .info-box p {
      font-size: 13px;
      color: #1e40af;
      line-height: 1.5;
    }
    
    .mock-code-box {
      background: #fef3c7;
      border: 2px dashed #f59e0b;
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
      text-align: center;
    }
    
    .mock-code-title {
      font-size: 14px;
      color: #92400e;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .mock-code {
      font-size: 32px;
      font-weight: 700;
      color: #f59e0b;
      letter-spacing: 8px;
      margin: 12px 0;
    }
    
    .mock-code-desc {
      font-size: 12px;
      color: #92400e;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">ğŸ¦ ì•Œë¹„</div>
      <h1>íœ´ëŒ€í° ë³¸ì¸ì¸ì¦</h1>
      <p class="subtitle">ë³¸ì¸ëª…ì˜ íœ´ëŒ€í°ìœ¼ë¡œ ì¸ì¦í•´ì£¼ì„¸ìš”</p>
    </div>
    
    <form id="verificationForm">
      <div class="form-group">
        <label class="form-label">ì´ë¦„ <span style="color: #dc2626;">*</span></label>
        <input type="text" class="form-input" id="name" placeholder="í™ê¸¸ë™" required>
      </div>
      
      <div class="form-group">
        <label class="form-label">í†µì‹ ì‚¬ ì„ íƒ</label>
        <select class="form-input" id="carrier" required>
          <option value="">í†µì‹ ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          <option value="SKT">SKT</option>
          <option value="KT">KT</option>
          <option value="LG U+">LG U+</option>
          <option value="SKT ì•Œëœ°í°">SKT ì•Œëœ°í°</option>
          <option value="KT ì•Œëœ°í°">KT ì•Œëœ°í°</option>
          <option value="LG U+ ì•Œëœ°í°">LG U+ ì•Œëœ°í°</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">íœ´ëŒ€í°ë²ˆí˜¸</label>
        <input type="tel" class="form-input" id="phone" placeholder="010-1234-5678" required>
      </div>
      
      <div class="form-group">
        <label class="form-label">ìƒë…„ì›”ì¼</label>
        <input type="text" class="form-input" id="birthDate" placeholder="YYYYMMDD (ì˜ˆ: 19900101)" maxlength="8" required>
      </div>
      
      <div class="form-group">
        <label class="form-label">ì„±ë³„</label>
        <select class="form-input" id="gender" required>
          <option value="">ì„±ë³„ ì„ íƒ</option>
          <option value="M">ë‚¨ì„±</option>
          <option value="F">ì—¬ì„±</option>
        </select>
      </div>
      
      <button type="button" class="btn btn-primary" onclick="startSMSVerification()">
        <i class="fas fa-comment-dots"></i> ì¸ì¦ë²ˆí˜¸ ë°›ê¸°
      </button>
    </form>
    
    <!-- ì¸ì¦ ë°©ë²• ì„ íƒ ì œê±°: SMS ì¸ì¦ë§Œ ì‚¬ìš© -->
    
    <div class="info-box">
      <p><i class="fas fa-info-circle"></i> ë³¸ì¸ëª…ì˜ íœ´ëŒ€í°ìœ¼ë¡œë§Œ ì¸ì¦ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      <p style="margin-top: 8px;"><i class="fas fa-shield-alt"></i> ì…ë ¥í•˜ì‹  ì •ë³´ëŠ” ì•ˆì „í•˜ê²Œ ë³´í˜¸ë©ë‹ˆë‹¤.</p>
    </div>
    
    <!-- SMS ì¸ì¦ë²ˆí˜¸ ì…ë ¥ -->
    <div id="smsVerification" style="display: none;">
      <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; margin-top: 20px;">
        <div style="text-align: center; margin-bottom: 16px;">
          <i class="fas fa-comment-dots" style="font-size: 32px; color: #3b82f6;"></i>
          <h3 style="font-size: 18px; font-weight: 600; color: #1e40af; margin-top: 12px; margin-bottom: 8px;">
            ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤
          </h3>
          <p style="font-size: 14px; color: #1e40af; margin: 0;">
            íœ´ëŒ€í°ìœ¼ë¡œ ë°›ì€ 6ìë¦¬ ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”
          </p>
          <p id="phoneDisplay" style="font-size: 14px; color: #3b82f6; font-weight: 600; margin-top: 8px;"></p>
        </div>
        
        <div class="form-group">
          <label class="form-label" style="color: #1e40af;">ì¸ì¦ë²ˆí˜¸ (6ìë¦¬)</label>
          <input type="text" class="form-input" id="verificationCode" placeholder="000000" maxlength="6" pattern="[0-9]{6}" style="font-size: 20px; text-align: center; letter-spacing: 8px; font-weight: 600;">
          <div id="codeError" style="color: #dc2626; font-size: 13px; margin-top: 8px; display: none;"></div>
        </div>
        
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button type="button" class="btn btn-primary" onclick="verifyCode()" id="verifyBtn" style="flex: 1;">
            <i class="fas fa-check"></i> ì¸ì¦ í™•ì¸
          </button>
          <button type="button" class="btn" onclick="resendCode()" style="flex: 1; background: #6b7280; color: white;">
            <i class="fas fa-redo"></i> ì¬ë°œì†¡
          </button>
        </div>
        
        <div id="timerDisplay" style="text-align: center; margin-top: 12px; font-size: 14px; color: #dc2626; font-weight: 600;"></div>
      </div>
      
      <!-- ê°œë°œ ëª¨ë“œ íŒíŠ¸ (SMS ë°œì†¡ ì‹¤íŒ¨ ì‹œì—ë§Œ í‘œì‹œ) -->
      <div id="devModeHint" style="display: none; background: #fef3c7; border: 2px dashed #f59e0b; border-radius: 8px; padding: 16px; margin-top: 16px; text-align: center;">
        <div style="font-size: 14px; color: #92400e; font-weight: 600; margin-bottom: 8px;">
          <i class="fas fa-code"></i> ê°œë°œ ëª¨ë“œ (SMS ë¯¸ë°œì†¡)
        </div>
        <div id="mockCode" style="font-size: 32px; font-weight: 700; color: #f59e0b; letter-spacing: 8px; margin: 12px 0;">------</div>
        <div style="font-size: 12px; color: #92400e;">
          ìœ„ ì½”ë“œë¥¼ ë³µì‚¬í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”
        </div>
      </div>
    </div>
  </div>

  <script>
    let timerInterval = null;
    let timeLeft = 300; // 5ë¶„ = 300ì´ˆ
    let currentPhone = '';
    let currentName = '';
    let currentCarrier = '';
    let currentBirthDate = '';
    let currentGender = '';
    
    // SMS ì¸ì¦ ì‹œì‘
    async function startSMSVerification() {
      const name = document.getElementById('name').value;
      const carrier = document.getElementById('carrier').value;
      const phone = document.getElementById('phone').value;
      const birthDate = document.getElementById('birthDate').value;
      const gender = document.getElementById('gender').value;
      
      if (!name) {
        alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!carrier) {
        alert('í†µì‹ ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!phone) {
        alert('íœ´ëŒ€í°ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦
      const cleanPhone = phone.replace(/-/g, '');
      if (!/^01[0-9]{8,9}$/.test(cleanPhone)) {
        alert('ì˜¬ë°”ë¥¸ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 010-1234-5678)');
        return;
      }
      
      if (!birthDate || birthDate.length !== 8) {
        alert('ìƒë…„ì›”ì¼ì„ 8ìë¦¬ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 19900101)');
        return;
      }
      
      if (!gender) {
        alert('ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // SMS ë°œì†¡
      await sendSMSCode(name, cleanPhone, carrier, birthDate, gender);
    }
    
    async function sendSMSCode(name, phone, carrier, birthDate, gender) {
      try {
        // í˜„ì¬ ì •ë³´ ì €ì¥
        currentPhone = phone;
        currentName = name;
        currentCarrier = carrier;
        currentBirthDate = birthDate;
        currentGender = gender;
        
        console.log('ğŸ“± SMS ë°œì†¡ ìš”ì²­:', { name, phone });
        
        // API í˜¸ì¶œí•˜ì—¬ SMS ë°œì†¡
        const response = await fetch('/api/sms/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name,
            phone
          })
        });
        
        const data = await response.json();
        console.log('ğŸ“¥ SMS ë°œì†¡ ì‘ë‹µ:', data);
        
        if (data.success) {
          // SMS ì¸ì¦ í™”ë©´ í‘œì‹œ
          document.getElementById('verificationForm').style.display = 'none';
          document.getElementById('smsVerification').style.display = 'block';
          
          // ì „í™”ë²ˆí˜¸ í‘œì‹œ
          document.getElementById('phoneDisplay').textContent = `ğŸ“± ${phone}`;
          
          // ê°œë°œ ëª¨ë“œ íŒíŠ¸ (SMS ë¯¸ë°œì†¡ ì‹œì—ë§Œ í‘œì‹œ)
          if (!data.smsDelivered && data.verificationCode) {
            document.getElementById('devModeHint').style.display = 'block';
            document.getElementById('mockCode').textContent = data.verificationCode;
          } else {
            document.getElementById('devModeHint').style.display = 'none';
          }
          
          // íƒ€ì´ë¨¸ ì‹œì‘
          startTimer();
          
          alert('âœ… ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          alert('âŒ SMS ë°œì†¡ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('âŒ SMS ë°œì†¡ ì˜¤ë¥˜:', error);
        alert('SMS ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    function startTimer() {
      timeLeft = 300; // 5ë¶„ ì´ˆê¸°í™”
      updateTimerDisplay();
      
      // ê¸°ì¡´ íƒ€ì´ë¨¸ ì œê±°
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      // ìƒˆ íƒ€ì´ë¨¸ ì‹œì‘
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          alert('ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          window.location.reload();
        }
      }, 1000);
    }
    
    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      document.getElementById('timerDisplay').textContent = `â±ï¸ ë‚¨ì€ ì‹œê°„: ${display}`;
      
      // 1ë¶„ ì´í•˜ë©´ ë¹¨ê°„ìƒ‰
      if (timeLeft <= 60) {
        document.getElementById('timerDisplay').style.color = '#dc2626';
      }
    }
    
    async function verifyCode() {
      const code = document.getElementById('verificationCode').value.trim();
      const codeError = document.getElementById('codeError');
      const verifyBtn = document.getElementById('verifyBtn');
      
      // ì…ë ¥ê°’ ê²€ì¦
      if (!code) {
        codeError.textContent = 'âš ï¸ ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        codeError.style.display = 'block';
        return;
      }
      
      if (!/^[0-9]{6}$/.test(code)) {
        codeError.textContent = 'âš ï¸ 6ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        codeError.style.display = 'block';
        return;
      }
      
      // ë²„íŠ¼ ë¹„í™œì„±í™”
      verifyBtn.disabled = true;
      verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> í™•ì¸ ì¤‘...';
      codeError.style.display = 'none';
      
      try {
        console.log('ğŸ” ì¸ì¦ë²ˆí˜¸ í™•ì¸:', { phone: currentPhone, code });
        
        // ì¸ì¦ë²ˆí˜¸ í™•ì¸ API í˜¸ì¶œ
        const response = await fetch('/api/sms/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            phone: currentPhone,
            code: code
          })
        });
        
        const data = await response.json();
        console.log('ğŸ“¥ ì¸ì¦ í™•ì¸ ì‘ë‹µ:', data);
        
        if (data.success) {
          // ì¸ì¦ ì„±ê³µ
          clearInterval(timerInterval);
          
          // ë¶€ëª¨ ì°½ì— ì¸ì¦ ì™„ë£Œ ë©”ì‹œì§€ ì „ì†¡
          if (window.opener) {
            window.opener.postMessage({
              type: 'PHONE_VERIFICATION_SUCCESS',
              name: currentName,
              phone: currentPhone,
              carrier: currentCarrier,
              birthDate: currentBirthDate,
              gender: currentGender,
              verificationToken: data.verificationToken
            }, '*');
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í›„ íŒì—… ë‹«ê¸°
            alert('âœ… ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            setTimeout(() => {
              window.close();
            }, 500);
          } else {
            alert('âœ… ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
          }
        } else {
          // ì¸ì¦ ì‹¤íŒ¨
          codeError.textContent = 'âŒ ' + (data.error || 'ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          codeError.style.display = 'block';
          verifyBtn.disabled = false;
          verifyBtn.innerHTML = '<i class="fas fa-check"></i> ì¸ì¦ í™•ì¸';
        }
      } catch (error) {
        console.error('âŒ ì¸ì¦ í™•ì¸ ì˜¤ë¥˜:', error);
        codeError.textContent = 'âŒ ì¸ì¦ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        codeError.style.display = 'block';
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = '<i class="fas fa-check"></i> ì¸ì¦ í™•ì¸';
      }
    }
    
    async function resendCode() {
      if (!confirm('ì¸ì¦ë²ˆí˜¸ë¥¼ ì¬ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      // SMS ì¬ë°œì†¡
      await sendSMSCode(currentName, currentPhone, currentCarrier, currentBirthDate, currentGender);
      
      // ì…ë ¥ì°½ ì´ˆê¸°í™”
      document.getElementById('verificationCode').value = '';
      document.getElementById('codeError').style.display = 'none';
    }
    
    // Enter í‚¤ë¡œ ì¸ì¦ í™•ì¸
    document.addEventListener('DOMContentLoaded', () => {
      const codeInput = document.getElementById('verificationCode');
      if (codeInput) {
        codeInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            verifyCode();
          }
        });
        
        // ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥
        codeInput.addEventListener('input', (e) => {
          e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
      }
    });
  </script>
</body>
</html>
