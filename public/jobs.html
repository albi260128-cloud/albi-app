<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì•Œë°”ì°¾ê¸° - ì•Œë¹„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
  <!-- ë„¤ì´ë²„ ì§€ë„ API -->
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=h46g2mh4yh"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Pretendard', 'Apple SD Gothic Neo', sans-serif;
    }
    #map { 
      width: 100%; 
      height: calc(100vh - 200px); 
    }
    .job-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .filter-chip.active {
      background: #FF6B35;
      color: white;
      border-color: #FF6B35;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between max-w-1200px">
      <a href="/" class="flex items-center space-x-2">
        <img src="/albi-mascot.svg" alt="ì•Œë¹„" style="width: 32px; height: 32px;">
        <div class="flex flex-col">
          <span class="text-xl font-bold text-gray-800">ë‚´ ì£¼ë³€ ì•Œë°”</span>
          <span id="locationStatus" class="text-xs text-gray-500">ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...</span>
        </div>
      </a>
      <a href="/post-job" class="px-4 py-2 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition flex items-center gap-2">
        <i class="fas fa-plus"></i>
        <span class="hidden sm:inline">ê³µê³ ì˜¬ë¦¬ê¸°</span>
      </a>
    </div>
  </nav>

  <!-- ë·° í† ê¸€ íƒ­ -->
  <div class="bg-white border-b sticky top-16 z-40">
    <div class="container mx-auto px-4 max-w-1200px flex">
      <button onclick="switchView('list')" id="listTab" class="flex-1 py-3 text-sm font-bold text-orange-500 border-b-2 border-orange-500 transition">
        <i class="fas fa-list mr-1"></i> ë¦¬ìŠ¤íŠ¸
      </button>
      <button onclick="switchView('map')" id="mapTab" class="flex-1 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent transition hover:text-orange-500">
        <i class="fas fa-map mr-1"></i> ì§€ë„
      </button>
    </div>
  </div>

  <!-- í•„í„° ë°” -->
  <div class="bg-white px-4 py-3 border-b sticky top-28 z-40">
    <div class="container mx-auto max-w-1200px">
      <div class="flex items-center gap-2 overflow-x-auto scrollbar-hide">
        <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
        <button onclick="filterByCategory('all')" data-category="all" class="filter-chip active px-4 py-2 rounded-full border-2 text-sm whitespace-nowrap transition">
          ì „ì²´
        </button>
        <button onclick="filterByCategory('cafe')" data-category="cafe" class="filter-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm whitespace-nowrap transition">
          â˜• ì¹´í˜
        </button>
        <button onclick="filterByCategory('convenience')" data-category="convenience" class="filter-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm whitespace-nowrap transition">
          ğŸª í¸ì˜ì 
        </button>
        <button onclick="filterByCategory('restaurant')" data-category="restaurant" class="filter-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm whitespace-nowrap transition">
          ğŸ½ï¸ ìŒì‹ì 
        </button>
        <button onclick="filterByCategory('fastfood')" data-category="fastfood" class="filter-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm whitespace-nowrap transition">
          ğŸ” íŒ¨ìŠ¤íŠ¸í‘¸ë“œ
        </button>
        <button onclick="filterByCategory('retail')" data-category="retail" class="filter-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm whitespace-nowrap transition">
          ğŸ‘• ë§¤ì¥
        </button>
        <button onclick="filterByCategory('other')" data-category="other" class="filter-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm whitespace-nowrap transition">
          ğŸ“¦ ê¸°íƒ€
        </button>
        
        <div class="w-px h-6 bg-gray-300 mx-2"></div>
        
        <!-- ì •ë ¬ í•„í„° -->
        <select id="sortFilter" onchange="filterJobs()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
          <option value="distance">ê°€ê¹Œìš´ìˆœ</option>
          <option value="wage">ë†’ì€ì‹œê¸‰ìˆœ</option>
          <option value="views">ì¸ê¸°ìˆœ</option>
        </select>

        <button onclick="getCurrentLocation()" id="locationBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-600 transition ml-auto whitespace-nowrap">
          <i class="fas fa-location-arrow mr-1"></i>
          í˜„ìœ„ì¹˜
        </button>
      </div>
    </div>
  </div>

  <!-- ë¦¬ìŠ¤íŠ¸ ë·° -->
  <div id="listView" class="container mx-auto px-4 py-6 max-w-1200px mb-20">
    <!-- ë¡œë”© ìƒíƒœ -->
    <div id="loading" class="text-center py-12">
      <img src="/albi-mascot.svg" alt="ë¡œë”©" class="w-16 h-16 mx-auto mb-4 animate-bounce">
      <p class="text-gray-600">ì£¼ë³€ ì•Œë°”ë¥¼ ì°¾ê³  ìˆì–´ìš”...</p>
    </div>
    
    <!-- ê³µê³  ë¦¬ìŠ¤íŠ¸ -->
    <div id="jobsList" class="space-y-4">
      <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
    </div>

    <!-- ê²°ê³¼ ì—†ìŒ -->
    <div id="noResults" class="hidden text-center py-12">
      <div class="text-6xl mb-4">ğŸ˜¢</div>
      <h3 class="text-2xl font-bold text-gray-800 mb-2">ì£¼ë³€ì— ê³µê³ ê°€ ì—†ì–´ìš”</h3>
      <p class="text-gray-600 mb-6">ê²€ìƒ‰ ë°˜ê²½ì„ ë„“íˆê±°ë‚˜ ë‹¤ë¥¸ ì§€ì—­ì„ í™•ì¸í•´ë³´ì„¸ìš”</p>
      <button onclick="getCurrentLocation()" class="px-6 py-3 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition">
        <i class="fas fa-redo mr-2"></i>
        ë‹¤ì‹œ ê²€ìƒ‰
      </button>
    </div>
  </div>

  <!-- ì§€ë„ ë·° -->
  <div id="mapView" class="hidden relative">
    <div id="map"></div>
    <div class="absolute top-4 left-4 bg-white rounded-lg shadow-lg p-3 z-10">
      <p class="text-xs text-gray-600 flex items-center gap-2">
        <span class="w-3 h-3 bg-blue-500 rounded-full"></span> ë‚´ ìœ„ì¹˜
        <span class="w-3 h-3 bg-orange-500 rounded-full ml-2"></span> ì•Œë°” ê³µê³ 
      </p>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t z-50 md:hidden">
    <div class="grid grid-cols-4">
      <a href="/" class="flex flex-col items-center py-3 text-gray-600 hover:text-orange-500">
        <i class="fas fa-home text-xl mb-1"></i>
        <span class="text-xs">í™ˆ</span>
      </a>
      <a href="/jobs" class="flex flex-col items-center py-3 text-orange-500">
        <i class="fas fa-briefcase text-xl mb-1"></i>
        <span class="text-xs">ì•Œë°”ì°¾ê¸°</span>
      </a>
      <a href="/community.html" class="flex flex-col items-center py-3 text-gray-600 hover:text-orange-500">
        <i class="fas fa-comments text-xl mb-1"></i>
        <span class="text-xs">ì»¤ë®¤ë‹ˆí‹°</span>
      </a>
      <a href="/mypage.html" class="flex flex-col items-center py-3 text-gray-600 hover:text-orange-500">
        <i class="fas fa-user text-xl mb-1"></i>
        <span class="text-xs">MY</span>
      </a>
    </div>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script>
    let currentLocation = { lat: 37.5665, lng: 126.9780 }; // ê¸°ë³¸: ì„œìš¸ì‹œì²­
    let allJobs = [];
    let map = null;
    let markers = [];
    let currentView = 'list';

    const categoryIcons = {
      cafe: 'â˜•',
      convenience: 'ğŸª', 
      restaurant: 'ğŸ½ï¸',
      retail: 'ğŸ‘•',
      delivery: 'ğŸ›µ',
      etc: 'ğŸ’¼'
    };

    // ì´ˆê¸°í™”
    window.onload = function() {
      getCurrentLocation();
    };

    // ë·° ì „í™˜
    function switchView(view) {
      currentView = view;
      const listView = document.getElementById('listView');
      const mapView = document.getElementById('mapView');
      const listTab = document.getElementById('listTab');
      const mapTab = document.getElementById('mapTab');

      if (view === 'list') {
        listView.classList.remove('hidden');
        mapView.classList.add('hidden');
        listTab.className = 'flex-1 py-3 text-sm font-bold text-orange-500 border-b-2 border-orange-500 transition';
        mapTab.className = 'flex-1 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent transition hover:text-orange-500';
      } else {
        listView.classList.add('hidden');
        mapView.classList.remove('hidden');
        listTab.className = 'flex-1 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent transition hover:text-orange-500';
        mapTab.className = 'flex-1 py-3 text-sm font-bold text-orange-500 border-b-2 border-orange-500 transition';
        
        if (!map) initMap();
        else if (map.relayout) map.relayout();
      }
    }
    
    // ì¹´í…Œê³ ë¦¬ í•„í„°
    function filterByCategory(category) {
      document.querySelectorAll('.filter-chip').forEach(chip => {
        if (chip.dataset.category === category) {
          chip.classList.add('active');
        } else {
          chip.classList.remove('active');
        }
      });
      
      filterJobs();
    }

    // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
    function getCurrentLocation() {
      const btn = document.getElementById('locationBtn');
      const status = document.getElementById('locationStatus');
      
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> í™•ì¸ì¤‘...';
      btn.disabled = true;

      if (!navigator.geolocation) {
        alert('ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
        btn.innerHTML = '<i class="fas fa-location-arrow mr-1"></i> í˜„ìœ„ì¹˜';
        btn.disabled = false;
        loadJobs();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          currentLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          status.textContent = 'ë°˜ê²½ 3km ë‚´ ê³µê³ ';
          btn.innerHTML = '<i class="fas fa-check-circle mr-1"></i> í˜„ìœ„ì¹˜';
          btn.className = 'px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-semibold ml-auto whitespace-nowrap';
          btn.disabled = false;
          
          loadJobs();
        },
        (error) => {
          console.error('Geolocation error:', error);
          status.textContent = 'ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤';
          btn.innerHTML = '<i class="fas fa-location-arrow mr-1"></i> í˜„ìœ„ì¹˜';
          btn.disabled = false;
          loadJobs(); // ê¸°ë³¸ ìœ„ì¹˜ë¡œ ë¡œë“œ
        }
      );
    }

    // ê³µê³  ë°ì´í„° ë¡œë“œ
    async function loadJobs() {
      try {
        document.getElementById('loading').classList.remove('hidden');
        
        const activeChip = document.querySelector('.filter-chip.active');
        const category = activeChip ? activeChip.dataset.category : 'all';
        const sort = document.getElementById('sortFilter').value;
        
        const params = new URLSearchParams({
          lat: currentLocation.lat.toString(),
          lng: currentLocation.lng.toString(),
          radius: '3',
          category,
          sort
        });

        const response = await axios.get(`/api/jobs/nearby?${params}`);

        if (response.data.success) {
          allJobs = response.data.data.jobs;
          renderJobs();
          if (currentView === 'map') updateMap();
        } else {
          throw new Error(response.data.error);
        }
      } catch (error) {
        console.error('Load jobs error:', error);
        // ëª©ì—… ë°ì´í„°ë¡œ ëŒ€ì²´
        renderMockJobs();
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    // ëª©ì—… ë°ì´í„°ë¡œ ê³µê³  ë Œë”ë§
    function renderMockJobs() {
      const mockJobs = [
        {
          id: 1,
          category: 'cafe',
          title: 'ìŠ¤íƒ€ë²…ìŠ¤ ê°•ë‚¨ì  ë°”ë¦¬ìŠ¤íƒ€',
          location: 'ì„œìš¸ ê°•ë‚¨êµ¬',
          distance: 0.8,
          hourly_wage: 12000,
          tags: ['ì¥ê¸°', 'ì£¼ë§', 'ì˜¤ì „'],
          views: 234,
          has_trial: true
        },
        {
          id: 2,
          category: 'convenience',
          title: 'CU ì—­ì‚¼ì  ì•¼ê°„ ì•Œë°”',
          location: 'ì„œìš¸ ê°•ë‚¨êµ¬',
          distance: 1.2,
          hourly_wage: 13500,
          tags: ['ì•¼ê°„', 'ë‹¨ê¸°ê°€ëŠ¥', 'ê¸‰êµ¬'],
          views: 456,
          has_trial: true
        },
        {
          id: 3,
          category: 'restaurant',
          title: 'í•œì‹ë‹¹ í™€ì„œë¹™',
          location: 'ì„œìš¸ ê°•ë‚¨êµ¬',
          distance: 1.5,
          hourly_wage: 11000,
          tags: ['ì¥ê¸°', 'ì‹ì‚¬ì œê³µ', 'ì£¼ì¤‘'],
          views: 189,
          has_trial: true
        },
        {
          id: 4,
          category: 'retail',
          title: 'ì˜ë¥˜ë§¤ì¥ íŒë§¤ì§',
          location: 'ì„œìš¸ ê°•ë‚¨êµ¬',
          distance: 2.1,
          hourly_wage: 12500,
          tags: ['ì£¼ë§', 'ì¥ê¸°', 'ì¸ì„¼í‹°ë¸Œ'],
          views: 345,
          has_trial: true
        }
      ];

      allJobs = mockJobs;
      renderJobs();
    }

    // ê³µê³  ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderJobs() {
      const container = document.getElementById('jobsList');
      const noResults = document.getElementById('noResults');

      if (allJobs.length === 0) {
        container.innerHTML = '';
        noResults.classList.remove('hidden');
        return;
      }

      noResults.classList.add('hidden');
      
      container.innerHTML = allJobs.map(job => `
        <div onclick="viewJobDetail('${job.id}')" class="job-card bg-white rounded-lg border border-gray-200 p-5 cursor-pointer transition-all">
          <div class="flex items-start gap-4 mb-4">
            <div class="w-14 h-14 bg-gray-100 rounded-lg flex items-center justify-center text-3xl flex-shrink-0">
              ${categoryIcons[job.category] || 'ğŸ’¼'}
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="text-lg font-bold text-gray-800 mb-1 truncate">${job.title}</h3>
              <div class="flex items-center gap-2 text-sm text-gray-600">
                <i class="fas fa-map-marker-alt text-orange-500"></i>
                <span>${job.location}</span>
                ${job.distance ? `<span class="px-2 py-0.5 bg-blue-100 text-blue-600 rounded-full text-xs font-semibold">${job.distance}km</span>` : ''}
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-orange-500">${job.hourly_wage.toLocaleString()}<span class="text-sm font-medium text-gray-600">ì›</span></div>
              <div class="text-xs text-gray-500">ì‹œê¸‰</div>
            </div>
          </div>
          
          <div class="flex items-center gap-2 flex-wrap">
            ${job.has_trial ? '<span class="px-3 py-1 bg-orange-100 text-orange-600 rounded-full text-xs font-semibold"><i class="fas fa-eye mr-1"></i>1ì‹œê°„ ì²´í—˜</span>' : ''}
            ${(job.tags || []).slice(0, 3).map(tag => `
              <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">#${tag}</span>
            `).join('')}
            <span class="px-2 py-1 text-gray-500 text-xs ml-auto flex items-center gap-1">
              <i class="fas fa-eye"></i> ${job.views || 0}
            </span>
          </div>
        </div>
      `).join('');
    }

    // ì§€ë„ ì´ˆê¸°í™”
    function initMap() {
      if (!window.naver || !window.naver.maps) {
        console.warn('Naver Maps API ì—†ìŒ - ì§€ë„ ê¸°ëŠ¥ ë¹„í™œì„±í™”');
        document.getElementById('mapView').innerHTML = 
          '<div class="flex items-center justify-center h-screen"><p class="text-gray-500">ì§€ë„ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
      }

      const container = document.getElementById('map');
      const options = {
        center: new naver.maps.LatLng(currentLocation.lat, currentLocation.lng),
        zoom: 14,
        mapTypeControl: false,
        scaleControl: true,
        logoControl: false,
        mapDataControl: false,
        zoomControl: true,
        zoomControlOptions: {
          position: naver.maps.Position.TOP_LEFT
        }
      };

      map = new naver.maps.Map(container, options);
      updateMap();
    }

    // ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸
    function updateMap() {
      if (!map || !window.naver) return;

      markers.forEach(marker => marker.setMap(null));
      markers = [];

      // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
      const myPosition = new naver.maps.LatLng(currentLocation.lat, currentLocation.lng);
      const myMarker = new naver.maps.Marker({
        position: myPosition,
        map: map,
        icon: {
          content: '<div style="background: #FF6B35; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
          anchor: new naver.maps.Point(10, 10)
        },
        title: 'ë‚´ ìœ„ì¹˜'
      });
      markers.push(myMarker);

      // ì•Œë°” ë§ˆì»¤ë“¤
      allJobs.forEach(job => {
        if (!job.latitude || !job.longitude) return;

        const position = new naver.maps.LatLng(job.latitude, job.longitude);
        const marker = new naver.maps.Marker({
          position: position,
          map: map,
          icon: {
            content: `<div style="background: white; padding: 6px 10px; border-radius: 16px; border: 2px solid #FF6B35; font-size: 12px; font-weight: 600; color: #FF6B35; box-shadow: 0 2px 6px rgba(0,0,0,0.2); white-space: nowrap;">${job.hourly_wage.toLocaleString()}ì›</div>`,
            anchor: new naver.maps.Point(30, 35)
          },
          title: job.title
        });

        // ì •ë³´ ì°½ ìƒì„±
        const infoWindow = new naver.maps.InfoWindow({
          content: `
            <div style="padding:15px; min-width:220px; text-align:center; border-radius: 8px;">
              <div style="font-weight:bold; margin-bottom:8px; font-size: 14px; color: #333;">${job.title}</div>
              <div style="color:#f97316; font-weight:bold; font-size:18px; margin-bottom:8px;">
                ì‹œê¸‰ ${job.hourly_wage.toLocaleString()}ì›
              </div>
              <div style="color:#666; font-size:13px; margin-bottom:10px;">
                ğŸ“ ${job.distance}km Â· ${job.company}
              </div>
              <button onclick="viewJobDetail('${job.id}')" 
                      style="background:#f97316; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:13px; font-weight: 600;">
                ìƒì„¸ë³´ê¸°
              </button>
            </div>
          `,
          borderWidth: 0,
          backgroundColor: 'transparent',
          anchorSize: new naver.maps.Size(0, 0),
          pixelOffset: new naver.maps.Point(0, -10)
        });

        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
        naver.maps.Event.addListener(marker, 'click', () => {
          // ë‹¤ë¥¸ ì •ë³´ì°½ ë‹«ê¸°
          markers.forEach(m => {
            if (m._infoWindow) {
              m._infoWindow.close();
            }
          });
          
          infoWindow.open(map, marker);
          marker._infoWindow = infoWindow;
        });

        markers.push(marker);
      });
    }

    // í•„í„° ë³€ê²½ ì‹œ ì¬ê²€ìƒ‰
    function filterJobs() {
      loadJobs();
    }

    // ê³µê³  ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    function viewJobDetail(jobId) {
      window.location.href = `/job-detail.html?id=${jobId}`;
    }
  </script>
</body>
</html>
