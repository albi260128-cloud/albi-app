<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚´ ì£¼ë³€ ì•Œë°” - ì•Œë¹„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_APP_KEY&libraries=services"></script>
  <style>
    .job-card { transition: all 0.3s ease; }
    .job-card:hover { transform: translateY(-4px); }
    #map { width: 100%; height: calc(100vh - 200px); }
  </style>
</head>
<body class="bg-gray-50 pb-20">
  <!-- ìƒë‹¨ í—¤ë” -->
  <header class="bg-white sticky top-0 z-50 shadow-sm">
    <div class="px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <span class="text-2xl">ğŸœ</span>
        <div>
          <h1 class="font-bold text-lg">ë‚´ ì£¼ë³€ ì•Œë°”</h1>
          <p class="text-xs text-gray-500" id="locationStatus">ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...</p>
        </div>
      </div>
      <a href="/post-job" class="bg-orange-500 text-white px-4 py-2 rounded-full text-sm font-bold hover:bg-orange-600">
        + ê³µê³  ì˜¬ë¦¬ê¸°
      </a>
    </div>
    
    <!-- ë·° ì „í™˜ íƒ­ -->
    <div class="flex border-b">
      <button onclick="switchView('list')" id="listTab" 
              class="flex-1 py-3 text-sm font-bold text-orange-500 border-b-2 border-orange-500">
        ğŸ“‹ ë¦¬ìŠ¤íŠ¸
      </button>
      <button onclick="switchView('map')" id="mapTab" 
              class="flex-1 py-3 text-sm font-bold text-gray-500 hover:text-orange-500">
        ğŸ—ºï¸ ì§€ë„
      </button>
    </div>
  </header>

  <!-- í•„í„° ë°” -->
  <div class="bg-white px-4 py-3 border-b">
    <div class="flex items-center space-x-3 overflow-x-auto">
      <select id="categoryFilter" onchange="filterJobs()" 
              class="px-3 py-2 border rounded-lg text-sm focus:outline-none focus:border-orange-500">
        <option value="all">ì „ì²´</option>
        <option value="cafe">ì¹´í˜ â˜•</option>
        <option value="convenience">í¸ì˜ì  ğŸª</option>
        <option value="restaurant">ìŒì‹ì  ğŸ½ï¸</option>
        <option value="retail">ë§¤ì¥ ğŸ‘•</option>
        <option value="etc">ê¸°íƒ€</option>
      </select>
      
      <select id="sortFilter" onchange="filterJobs()"
              class="px-3 py-2 border rounded-lg text-sm focus:outline-none focus:border-orange-500">
        <option value="distance">ê°€ê¹Œìš´ìˆœ</option>
        <option value="wage">ë†’ì€ì‹œê¸‰ìˆœ</option>
        <option value="views">ì¸ê¸°ìˆœ</option>
        <option value="recent">ìµœì‹ ìˆœ</option>
      </select>

      <button onclick="getCurrentLocation()" id="locationBtn"
              class="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-bold hover:bg-blue-100 whitespace-nowrap">
        ğŸ“ í˜„ìœ„ì¹˜
      </button>
    </div>
  </div>

  <!-- ë¦¬ìŠ¤íŠ¸ ë·° -->
  <div id="listView" class="p-4">
    <div id="loading" class="text-center py-12">
      <div class="text-4xl mb-4 animate-bounce">ğŸœ</div>
      <p class="text-gray-600">ì£¼ë³€ ì•Œë°”ë¥¼ ì°¾ê³  ìˆì–´ìš”...</p>
    </div>
    
    <div id="jobsList" class="space-y-4">
      <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
    </div>

    <div id="noResults" class="hidden text-center py-12">
      <div class="text-6xl mb-4">ğŸ˜¢</div>
      <h3 class="text-xl font-bold mb-2">ì£¼ë³€ì— ê³µê³ ê°€ ì—†ì–´ìš”</h3>
      <p class="text-gray-600 mb-4">ê²€ìƒ‰ ë°˜ê²½ì„ ë„“íˆê±°ë‚˜ ë‹¤ë¥¸ ì§€ì—­ì„ í™•ì¸í•´ë³´ì„¸ìš”</p>
    </div>
  </div>

  <!-- ì§€ë„ ë·° -->
  <div id="mapView" class="hidden relative">
    <div id="map"></div>
    <div class="absolute top-4 left-4 bg-white p-2 rounded-lg shadow-lg z-10">
      <p class="text-xs text-gray-600">ğŸ”µ ë‚´ ìœ„ì¹˜ | ğŸ§¡ ì•Œë°” ê³µê³ </p>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 z-50">
    <a href="/" class="flex flex-col items-center space-y-1 text-gray-500">
      <span class="text-xl">ğŸ </span>
      <span class="text-xs">í™ˆ</span>
    </a>
    <a href="/jobs" class="flex flex-col items-center space-y-1 text-orange-500 font-bold">
      <span class="text-xl">ğŸ“</span>
      <span class="text-xs">ë‚´ì£¼ë³€</span>
    </a>
    <a href="/chat" class="flex flex-col items-center space-y-1 text-gray-500">
      <span class="text-xl">ğŸ’¬</span>
      <span class="text-xs">ì±„íŒ…</span>
    </a>
    <a href="/store" class="flex flex-col items-center space-y-1 text-gray-500">
      <span class="text-xl">ğŸ</span>
      <span class="text-xs">ìŠ¤í† ì–´</span>
    </a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script>
    let currentLocation = { lat: 37.5665, lng: 126.9780 }; // ê¸°ë³¸: ì„œìš¸ì‹œì²­
    let allJobs = [];
    let map = null;
    let markers = [];
    let currentView = 'list';

    const categoryIcons = {
      cafe: 'â˜•',
      convenience: 'ğŸª', 
      restaurant: 'ğŸ½ï¸',
      retail: 'ğŸ‘•',
      etc: 'ğŸ’¼'
    };

    // ì´ˆê¸°í™”
    window.onload = function() {
      getCurrentLocation();
    };

    // ë·° ì „í™˜
    function switchView(view) {
      currentView = view;
      const listView = document.getElementById('listView');
      const mapView = document.getElementById('mapView');
      const listTab = document.getElementById('listTab');
      const mapTab = document.getElementById('mapTab');

      if (view === 'list') {
        listView.classList.remove('hidden');
        mapView.classList.add('hidden');
        listTab.className = 'flex-1 py-3 text-sm font-bold text-orange-500 border-b-2 border-orange-500';
        mapTab.className = 'flex-1 py-3 text-sm font-bold text-gray-500 hover:text-orange-500';
      } else {
        listView.classList.add('hidden');
        mapView.classList.remove('hidden');
        listTab.className = 'flex-1 py-3 text-sm font-bold text-gray-500 hover:text-orange-500';
        mapTab.className = 'flex-1 py-3 text-sm font-bold text-orange-500 border-b-2 border-orange-500';
        
        if (!map) initMap();
        else if (map.relayout) map.relayout();
      }
    }

    // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
    function getCurrentLocation() {
      const btn = document.getElementById('locationBtn');
      const status = document.getElementById('locationStatus');
      
      btn.textContent = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
      btn.disabled = true;

      if (!navigator.geolocation) {
        alert('ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
        loadJobs();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          currentLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          status.textContent = `ë°˜ê²½ 3km ë‚´ ê³µê³ `;
          btn.textContent = 'âœ“ í˜„ìœ„ì¹˜';
          btn.classList.remove('bg-blue-50', 'text-blue-600');
          btn.classList.add('bg-green-50', 'text-green-600');
          btn.disabled = false;
          
          loadJobs();
        },
        (error) => {
          console.error('Geolocation error:', error);
          status.textContent = 'ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤';
          btn.textContent = 'ğŸ“ í˜„ìœ„ì¹˜';
          btn.disabled = false;
          loadJobs(); // ê¸°ë³¸ ìœ„ì¹˜ë¡œ ë¡œë“œ
        }
      );
    }

    // ê³µê³  ë°ì´í„° ë¡œë“œ
    async function loadJobs() {
      try {
        document.getElementById('loading').classList.remove('hidden');
        
        const category = document.getElementById('categoryFilter').value;
        const sort = document.getElementById('sortFilter').value;
        
        const params = new URLSearchParams({
          lat: currentLocation.lat.toString(),
          lng: currentLocation.lng.toString(),
          radius: '3',
          category,
          sort
        });

        const response = await axios.get(`/api/jobs/nearby?${params}`);

        if (response.data.success) {
          allJobs = response.data.data.jobs;
          renderJobs();
          if (currentView === 'map') updateMap();
        } else {
          throw new Error(response.data.error);
        }
      } catch (error) {
        console.error('Load jobs error:', error);
        document.getElementById('loading').innerHTML = 
          '<div class="text-center text-red-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    // ê³µê³  ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderJobs() {
      const container = document.getElementById('jobsList');
      const noResults = document.getElementById('noResults');

      if (allJobs.length === 0) {
        container.innerHTML = '';
        noResults.classList.remove('hidden');
        return;
      }

      noResults.classList.add('hidden');
      
      container.innerHTML = allJobs.map(job => {
        const tags = JSON.parse(job.tags || '[]');
        const workDays = JSON.parse(job.work_days || '[]');
        
        return `
          <div onclick="viewJobDetail('${job.id}')" 
               class="job-card bg-white p-4 rounded-xl shadow-sm hover:shadow-lg cursor-pointer transition">
            <div class="flex items-start space-x-4">
              <div class="w-16 h-16 bg-orange-100 rounded-lg flex items-center justify-center text-2xl flex-shrink-0">
                ${categoryIcons[job.category] || 'ğŸ’¼'}
              </div>
              <div class="flex-1 min-w-0">
                <h3 class="font-bold text-gray-900 mb-1 truncate">${job.title}</h3>
                <div class="flex items-center text-sm text-gray-600 mb-2">
                  <span>ğŸ“ ${job.location}</span>
                  ${job.distance ? `<span class="ml-2 text-blue-600 font-bold">${job.distance}km</span>` : ''}
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-lg font-bold text-orange-600">${job.hourly_wage.toLocaleString()}ì›</span>
                  <div class="flex items-center space-x-2 text-xs text-gray-500">
                    <span>ğŸ‘ï¸ ${job.views || 0}</span>
                    <span class="bg-orange-50 text-orange-600 px-2 py-1 rounded-full">ì²´í—˜ê°€ëŠ¥</span>
                  </div>
                </div>
                ${tags.length > 0 ? `
                <div class="flex flex-wrap gap-1 mt-2">
                  ${tags.slice(0, 3).map(tag => `
                    <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">#${tag}</span>
                  `).join('')}
                </div>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ì§€ë„ ì´ˆê¸°í™”
    function initMap() {
      if (!window.kakao || !window.kakao.maps) {
        console.warn('Kakao Maps API ì—†ìŒ - ì§€ë„ ê¸°ëŠ¥ ë¹„í™œì„±í™”');
        document.getElementById('mapView').innerHTML = 
          '<div class="flex items-center justify-center h-full"><p class="text-gray-500">ì§€ë„ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
      }

      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng),
        level: 5
      };

      map = new kakao.maps.Map(container, options);
      updateMap();
    }

    // ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸
    function updateMap() {
      if (!map || !window.kakao) return;

      // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
      markers.forEach(marker => marker.setMap(null));
      markers = [];

      // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
      const myPosition = new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng);
      const myMarker = new kakao.maps.Marker({
        position: myPosition,
        map: map
      });
      markers.push(myMarker);

      // ê³µê³  ë§ˆì»¤ë“¤
      allJobs.forEach(job => {
        if (!job.latitude || !job.longitude) return;

        const position = new kakao.maps.LatLng(job.latitude, job.longitude);
        const marker = new kakao.maps.Marker({
          position: position,
          map: map
        });

        // ì¸í¬ìœˆë„ìš°
        const infoWindow = new kakao.maps.InfoWindow({
          content: `
            <div style="padding:10px; min-width:200px; text-align:center;">
              <div style="font-weight:bold; margin-bottom:5px;">${job.title}</div>
              <div style="color:#f97316; font-weight:bold; font-size:16px; margin-bottom:5px;">
                ${job.hourly_wage.toLocaleString()}ì›
              </div>
              <div style="color:#666; font-size:12px; margin-bottom:8px;">
                ğŸ“ ${job.distance}km
              </div>
              <button onclick="viewJobDetail('${job.id}')" 
                      style="background:#f97316; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px;">
                ìƒì„¸ë³´ê¸°
              </button>
            </div>
          `
        });

        kakao.maps.event.addListener(marker, 'click', () => {
          infoWindow.open(map, marker);
        });

        markers.push(marker);
      });
    }

    // í•„í„° ë³€ê²½ ì‹œ ì¬ê²€ìƒ‰
    function filterJobs() {
      loadJobs();
    }

    // ê³µê³  ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    function viewJobDetail(jobId) {
      window.location.href = `/job-detail?id=${jobId}`;
    }
  </script>
</body>
</html>
