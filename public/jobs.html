<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚´ ì£¼ë³€ ì•Œë°” - ì•Œë¹„</title>
  <link href="/styles.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_APP_KEY&libraries=services"></script>
  <style>
    #map { width: 100%; height: calc(100vh - 200px); }
    .map-info-window {
      padding: var(--space-sm);
      min-width: 200px;
    }
    .view-tab {
      transition: all var(--transition-fast);
    }
    .filter-chip {
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 2px solid transparent;
    }
    .filter-chip.active {
      background: var(--albi-orange);
      color: white;
      border-color: var(--albi-orange);
    }
    .filter-chip:not(.active) {
      background: var(--gray-200);
      color: var(--gray-700);
    }
    .filter-chip:not(.active):hover {
      background: var(--gray-300);
    }
  </style>
</head>
<body class="bg-gray-50 pb-20">
  <!-- Top Navigation -->
  <nav class="navbar">
    <div class="container flex items-center justify-between" style="max-width: 1200px;">
      <a href="/" class="navbar-brand">
        <img src="/albi-mascot.svg" alt="ì•Œë¹„" class="albi-mascot">
        <div class="flex flex-col">
          <span style="font-size: var(--font-size-lg);">ë‚´ ì£¼ë³€ ì•Œë°”</span>
          <span id="locationStatus" class="text-xs text-gray">ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...</span>
        </div>
      </a>
      
      <a href="/post-job" class="btn btn-primary btn-sm">
        <i class="fas fa-plus"></i>
        ê³µê³  ì˜¬ë¦¬ê¸°
      </a>
    </div>
  </nav>

  <div class="main-content">
    <!-- View Toggle Tabs -->
    <div class="bg-white border-b flex" style="position: sticky; top: 60px; z-index: var(--z-sticky);">
      <button onclick="switchView('list')" id="listTab" class="view-tab flex-1 py-3 text-sm font-bold text-orange border-b-2" style="border-color: var(--albi-orange);">
        <i class="fas fa-list"></i> ë¦¬ìŠ¤íŠ¸
      </button>
      <button onclick="switchView('map')" id="mapTab" class="view-tab flex-1 py-3 text-sm font-bold text-gray">
        <i class="fas fa-map"></i> ì§€ë„
      </button>
    </div>

    <!-- Filter Bar -->
    <div class="bg-white px-4 py-3 border-b" style="position: sticky; top: 108px; z-index: var(--z-sticky);">
      <div class="flex items-center gap-2 overflow-x-auto pb-2" style="scrollbar-width: none;">
        <!-- Category Filters -->
        <div class="flex gap-2">
          <button onclick="filterByCategory('all')" data-category="all" class="filter-chip active">
            ì „ì²´
          </button>
          <button onclick="filterByCategory('cafe')" data-category="cafe" class="filter-chip">
            â˜• ì¹´í˜
          </button>
          <button onclick="filterByCategory('convenience')" data-category="convenience" class="filter-chip">
            ğŸª í¸ì˜ì 
          </button>
          <button onclick="filterByCategory('restaurant')" data-category="restaurant" class="filter-chip">
            ğŸ½ï¸ ìŒì‹ì 
          </button>
          <button onclick="filterByCategory('retail')" data-category="retail" class="filter-chip">
            ğŸ‘• ë§¤ì¥
          </button>
        </div>

        <div style="width: 1px; height: 24px; background: var(--gray-300); margin: 0 var(--space-sm);"></div>
        
        <!-- Sort Filter -->
        <select id="sortFilter" onchange="filterJobs()" class="form-select" style="width: auto; padding: var(--space-xs) var(--space-md);">
          <option value="distance">ê°€ê¹Œìš´ìˆœ</option>
          <option value="wage">ë†’ì€ì‹œê¸‰ìˆœ</option>
          <option value="views">ì¸ê¸°ìˆœ</option>
        </select>

        <button onclick="getCurrentLocation()" id="locationBtn" class="btn btn-sm btn-secondary" style="margin-left: auto;">
          <i class="fas fa-location-arrow"></i>
          í˜„ìœ„ì¹˜
        </button>
      </div>
    </div>

    <!-- List View -->
    <div id="listView" class="p-4">
      <div id="loading" class="text-center py-12">
        <img src="/albi-mascot.svg" alt="ë¡œë”©" class="albi-mascot-lg mx-auto mb-3 mascot-float">
        <p class="text-gray">ì£¼ë³€ ì•Œë°”ë¥¼ ì°¾ê³  ìˆì–´ìš”...</p>
      </div>
      
      <div id="jobsList" class="grid gap-3">
        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
      </div>

      <div id="noResults" class="hidden empty-state">
        <div class="empty-state-icon">ğŸ˜¢</div>
        <h3 class="text-xl font-bold mb-2">ì£¼ë³€ì— ê³µê³ ê°€ ì—†ì–´ìš”</h3>
        <p class="text-gray mb-4">ê²€ìƒ‰ ë°˜ê²½ì„ ë„“íˆê±°ë‚˜ ë‹¤ë¥¸ ì§€ì—­ì„ í™•ì¸í•´ë³´ì„¸ìš”</p>
        <button onclick="getCurrentLocation()" class="btn btn-primary">
          <i class="fas fa-redo"></i>
          ë‹¤ì‹œ ê²€ìƒ‰
        </button>
      </div>
    </div>

    <!-- Map View -->
    <div id="mapView" class="hidden relative">
      <div id="map"></div>
      <div class="card" style="position: absolute; top: var(--space-lg); left: var(--space-lg); z-index: var(--z-dropdown); padding: var(--space-sm) var(--space-md);">
        <p class="text-xs text-gray flex items-center gap-2">
          <span class="badge badge-blue" style="width: 12px; height: 12px; padding: 0;"></span> ë‚´ ìœ„ì¹˜
          <span class="badge badge-orange" style="width: 12px; height: 12px; padding: 0;"></span> ì•Œë°” ê³µê³ 
        </p>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="/" class="nav-item">
      <i class="nav-item-icon fas fa-home"></i>
      <span>í™ˆ</span>
    </a>
    <a href="/jobs" class="nav-item active">
      <i class="nav-item-icon fas fa-briefcase"></i>
      <span>ë‚´ì£¼ë³€</span>
    </a>
    <a href="/community.html" class="nav-item">
      <i class="nav-item-icon fas fa-comments"></i>
      <span>ì»¤ë®¤ë‹ˆí‹°</span>
    </a>
    <a href="/store.html" class="nav-item">
      <i class="nav-item-icon fas fa-store"></i>
      <span>ìŠ¤í† ì–´</span>
    </a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script>
    let currentLocation = { lat: 37.5665, lng: 126.9780 }; // ê¸°ë³¸: ì„œìš¸ì‹œì²­
    let allJobs = [];
    let map = null;
    let markers = [];
    let currentView = 'list';

    const categoryIcons = {
      cafe: 'â˜•',
      convenience: 'ğŸª', 
      restaurant: 'ğŸ½ï¸',
      retail: 'ğŸ‘•',
      etc: 'ğŸ’¼'
    };

    // ì´ˆê¸°í™”
    window.onload = function() {
      getCurrentLocation();
    };

    // View toggle (updated for new UI)
    function switchView(view) {
      currentView = view;
      const listView = document.getElementById('listView');
      const mapView = document.getElementById('mapView');
      const listTab = document.getElementById('listTab');
      const mapTab = document.getElementById('mapTab');

      if (view === 'list') {
        listView.classList.remove('hidden');
        mapView.classList.add('hidden');
        listTab.className = 'view-tab flex-1 py-3 text-sm font-bold text-orange border-b-2';
        listTab.style.borderColor = 'var(--albi-orange)';
        mapTab.className = 'view-tab flex-1 py-3 text-sm font-bold text-gray';
        mapTab.style.borderColor = 'transparent';
      } else {
        listView.classList.add('hidden');
        mapView.classList.remove('hidden');
        listTab.className = 'view-tab flex-1 py-3 text-sm font-bold text-gray';
        listTab.style.borderColor = 'transparent';
        mapTab.className = 'view-tab flex-1 py-3 text-sm font-bold text-orange border-b-2';
        mapTab.style.borderColor = 'var(--albi-orange)';
        
        if (!map) initMap();
        else if (map.relayout) map.relayout();
      }
    }
    
    // Category filter with new chip UI
    function filterByCategory(category) {
      // Update active state
      document.querySelectorAll('.filter-chip').forEach(chip => {
        if (chip.dataset.category === category) {
          chip.classList.add('active');
        } else {
          chip.classList.remove('active');
        }
      });
      
      // Update category filter value
      const categoryFilter = document.getElementById('categoryFilter');
      if (categoryFilter) categoryFilter.value = category;
      
      // Reload jobs
      filterJobs();
    }

    // Get current location
    function getCurrentLocation() {
      const btn = document.getElementById('locationBtn');
      const status = document.getElementById('locationStatus');
      
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> í™•ì¸ì¤‘...';
      btn.disabled = true;

      if (!navigator.geolocation) {
        alert('ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
        btn.innerHTML = '<i class="fas fa-location-arrow"></i> í˜„ìœ„ì¹˜';
        btn.disabled = false;
        loadJobs();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          currentLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          status.textContent = `ë°˜ê²½ 3km ë‚´ ê³µê³ `;
          btn.innerHTML = '<i class="fas fa-check-circle"></i> í˜„ìœ„ì¹˜';
          btn.className = 'btn btn-sm' + ' ' + 'text-white';
          btn.style.background = 'var(--albi-green)';
          btn.disabled = false;
          
          loadJobs();
        },
        (error) => {
          console.error('Geolocation error:', error);
          status.textContent = 'ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤';
          btn.innerHTML = '<i class="fas fa-location-arrow"></i> í˜„ìœ„ì¹˜';
          btn.disabled = false;
          loadJobs(); // Load with default location
        }
      );
    }

    // Load jobs data
    async function loadJobs() {
      try {
        document.getElementById('loading').classList.remove('hidden');
        
        // Get active category from chip
        const activeChip = document.querySelector('.filter-chip.active');
        const category = activeChip ? activeChip.dataset.category : 'all';
        const sort = document.getElementById('sortFilter').value;
        
        const params = new URLSearchParams({
          lat: currentLocation.lat.toString(),
          lng: currentLocation.lng.toString(),
          radius: '3',
          category,
          sort
        });

        const response = await axios.get(`/api/jobs/nearby?${params}`);

        if (response.data.success) {
          allJobs = response.data.data.jobs;
          renderJobs();
          if (currentView === 'map') updateMap();
        } else {
          throw new Error(response.data.error);
        }
      } catch (error) {
        console.error('Load jobs error:', error);
        document.getElementById('loading').innerHTML = 
          '<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    // ê³µê³  ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderJobs() {
      const container = document.getElementById('jobsList');
      const noResults = document.getElementById('noResults');

      if (allJobs.length === 0) {
        container.innerHTML = '';
        noResults.classList.remove('hidden');
        return;
      }

      noResults.classList.add('hidden');
      
      container.innerHTML = allJobs.map(job => {
        const tags = JSON.parse(job.tags || '[]');
        const workDays = JSON.parse(job.work_days || '[]');
        
        return `
          <div onclick="viewJobDetail('${job.id}')" class="job-card">
            <div class="job-card-header">
              <div class="flex items-center gap-3">
                <div style="width: 56px; height: 56px; background: var(--gray-200); border-radius: var(--radius-lg); display: flex; align-items: center; justify-center; font-size: 2rem; flex-shrink: 0;">
                  ${categoryIcons[job.category] || 'ğŸ’¼'}
                </div>
                <div class="flex-1 min-w-0">
                  <h3 class="job-card-title truncate">${job.title}</h3>
                  <div class="flex items-center gap-2 text-sm text-gray">
                    <i class="fas fa-map-marker-alt text-orange"></i>
                    <span>${job.location}</span>
                    ${job.distance ? `<span class="badge badge-blue">${job.distance}km</span>` : ''}
                  </div>
                </div>
              </div>
              <div class="job-card-wage">
                ${job.hourly_wage.toLocaleString()}<span style="font-size: var(--font-size-sm); font-weight: 500;">ì›</span>
              </div>
            </div>
            
            <div class="job-card-footer">
              <span class="badge badge-orange">
                <i class="fas fa-eye"></i>
                1ì‹œê°„ ì²´í—˜ê°€ëŠ¥
              </span>
              ${tags.slice(0, 3).map(tag => `
                <span class="badge badge-gray">#${tag}</span>
              `).join('')}
              <span class="badge badge-outline" style="margin-left: auto;">
                <i class="fas fa-eye"></i> ${job.views || 0}
              </span>
            </div>
          </div>
        `;
      }).join('');
    }

    // ì§€ë„ ì´ˆê¸°í™”
    function initMap() {
      if (!window.kakao || !window.kakao.maps) {
        console.warn('Kakao Maps API ì—†ìŒ - ì§€ë„ ê¸°ëŠ¥ ë¹„í™œì„±í™”');
        document.getElementById('mapView').innerHTML = 
          '<div class="flex items-center justify-center h-full"><p class="text-gray-500">ì§€ë„ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
      }

      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng),
        level: 5
      };

      map = new kakao.maps.Map(container, options);
      updateMap();
    }

    // ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸
    function updateMap() {
      if (!map || !window.kakao) return;

      // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
      markers.forEach(marker => marker.setMap(null));
      markers = [];

      // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
      const myPosition = new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng);
      const myMarker = new kakao.maps.Marker({
        position: myPosition,
        map: map
      });
      markers.push(myMarker);

      // ê³µê³  ë§ˆì»¤ë“¤
      allJobs.forEach(job => {
        if (!job.latitude || !job.longitude) return;

        const position = new kakao.maps.LatLng(job.latitude, job.longitude);
        const marker = new kakao.maps.Marker({
          position: position,
          map: map
        });

        // ì¸í¬ìœˆë„ìš°
        const infoWindow = new kakao.maps.InfoWindow({
          content: `
            <div style="padding:10px; min-width:200px; text-align:center;">
              <div style="font-weight:bold; margin-bottom:5px;">${job.title}</div>
              <div style="color:#f97316; font-weight:bold; font-size:16px; margin-bottom:5px;">
                ${job.hourly_wage.toLocaleString()}ì›
              </div>
              <div style="color:#666; font-size:12px; margin-bottom:8px;">
                ğŸ“ ${job.distance}km
              </div>
              <button onclick="viewJobDetail('${job.id}')" 
                      style="background:#f97316; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px;">
                ìƒì„¸ë³´ê¸°
              </button>
            </div>
          `
        });

        kakao.maps.event.addListener(marker, 'click', () => {
          infoWindow.open(map, marker);
        });

        markers.push(marker);
      });
    }

    // í•„í„° ë³€ê²½ ì‹œ ì¬ê²€ìƒ‰
    function filterJobs() {
      loadJobs();
    }

    // ê³µê³  ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    function viewJobDetail(jobId) {
      window.location.href = `/job-detail?id=${jobId}`;
    }
  </script>
</body>
</html>
