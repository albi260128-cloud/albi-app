<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì•Œë¹„ ì»¤ë®¤ë‹ˆí‹° - ì•Œë¹„</title>
  <link href="/styles.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .category-chip {
      transition: all var(--transition-fast);
    }
  </style>
</head>
<body class="bg-gray-50 pb-20">
  <!-- Top Navigation -->
  <nav class="navbar">
    <div class="container flex items-center justify-between" style="max-width: 1200px;">
      <a href="/community.html" class="navbar-brand">
        <i class="fas fa-comments text-orange" style="font-size: 1.5rem;"></i>
        <span>ì•Œë¹„ í†¡í†¡</span>
      </a>
      
      <a href="/write-post.html" class="btn btn-primary btn-sm">
        <i class="fas fa-pencil-alt"></i>
        ê¸€ì“°ê¸°
      </a>
    </div>
  </nav>

  <div class="main-content">
    <!-- Category Tabs -->
    <div class="bg-white border-b" style="position: sticky; top: 60px; z-index: var(--z-sticky);">
      <div class="container" style="max-width: 1200px; padding: var(--space-md) var(--space-lg);">
        <div class="flex gap-2 overflow-x-auto pb-2" style="scrollbar-width: none;">
          <button onclick="filterCategory('all')" data-category="all" class="filter-chip active">
            ì „ì²´
          </button>
          <button onclick="filterCategory('free')" data-category="free" class="filter-chip">
            ğŸ—£ï¸ ììœ 
          </button>
          <button onclick="filterCategory('review')" data-category="review" class="filter-chip">
            ğŸ“ í›„ê¸°
          </button>
          <button onclick="filterCategory('question')" data-category="question" class="filter-chip">
            â“ ì§ˆë¬¸
          </button>
          <button onclick="filterCategory('tip')" data-category="tip" class="filter-chip">
            ğŸ’¡ ê¿€íŒ
          </button>
        </div>
      </div>
    </div>

    <!-- Sort Options -->
    <div class="bg-gray-100 border-b" style="position: sticky; top: 112px; z-index: var(--z-sticky);">
      <div class="container" style="max-width: 1200px; padding: var(--space-sm) var(--space-lg);">
        <select id="sortSelect" onchange="loadPosts()" class="form-select" style="width: auto; padding: var(--space-xs) var(--space-md);">
          <option value="latest">ìµœì‹ ìˆœ</option>
          <option value="popular">ì¸ê¸°ìˆœ</option>
          <option value="views">ì¡°íšŒìˆœ</option>
        </select>
      </div>
    </div>

    <!-- Posts List -->
    <div class="container container-md" style="padding-top: var(--space-lg);">
      <div id="loading" class="empty-state">
        <img src="/albi-mascot.svg" alt="ë¡œë”©" class="albi-mascot-lg mx-auto mb-3 mascot-float">
        <p class="text-gray">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>

      <div id="postsList" class="grid gap-3">
        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
      </div>

      <div id="loadMore" class="text-center py-4 hidden">
        <button onclick="loadMorePosts()" class="btn btn-outline">
          <i class="fas fa-chevron-down"></i>
          ë” ë³´ê¸°
        </button>
      </div>

      <div id="noResults" class="hidden empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <h3 class="text-xl font-bold mb-2">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ì–´ìš”</h3>
        <p class="text-gray mb-4">ì²« ë²ˆì§¸ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
        <a href="/write-post.html" class="btn btn-primary">
          <i class="fas fa-pencil-alt"></i>
          ê¸€ì“°ê¸°
        </a>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="/" class="nav-item">
      <i class="nav-item-icon fas fa-home"></i>
      <span>í™ˆ</span>
    </a>
    <a href="/jobs" class="nav-item">
      <i class="nav-item-icon fas fa-briefcase"></i>
      <span>ë‚´ì£¼ë³€</span>
    </a>
    <a href="/community.html" class="nav-item active">
      <i class="nav-item-icon fas fa-comments"></i>
      <span>ì»¤ë®¤ë‹ˆí‹°</span>
    </a>
    <a href="/store.html" class="nav-item">
      <i class="nav-item-icon fas fa-store"></i>
      <span>ìŠ¤í† ì–´</span>
    </a>
  </nav>

  <script>
    let currentCategory = 'all';
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;

    const categoryIcons = {
      free: 'ğŸ—£ï¸',
      review: 'ğŸ“',
      question: 'â“',
      tip: 'ğŸ’¡'
    };

    const categoryNames = {
      free: 'ììœ ',
      review: 'í›„ê¸°',
      question: 'ì§ˆë¬¸',
      tip: 'ê¿€íŒ'
    };

    // ì´ˆê¸°í™”
    window.onload = function() {
      loadPosts();
    };

    // Filter category with chip UI
    function filterCategory(category) {
      currentCategory = category;
      currentPage = 1;
      hasMore = true;
      document.getElementById('postsList').innerHTML = '';
      
      // Update active state for filter chips
      document.querySelectorAll('.filter-chip').forEach(chip => {
        if (chip.dataset.category === category) {
          chip.classList.add('active');
        } else {
          chip.classList.remove('active');
        }
      });

      loadPosts();
    }

    // ê²Œì‹œê¸€ ë¡œë“œ
    async function loadPosts() {
      if (isLoading) return;
      
      isLoading = true;
      document.getElementById('loading').classList.remove('hidden');

      try {
        const sort = document.getElementById('sortSelect').value;
        const params = new URLSearchParams({
          category: currentCategory,
          sort,
          page: currentPage.toString(),
          limit: '20'
        });

        const response = await fetch(`/api/community/posts?${params}`);
        const data = await response.json();

        if (data.success) {
          renderPosts(data.data.posts, currentPage === 1);
          hasMore = data.data.hasMore;
          
          if (hasMore) {
            document.getElementById('loadMore').classList.remove('hidden');
          } else {
            document.getElementById('loadMore').classList.add('hidden');
          }

          if (data.data.posts.length === 0 && currentPage === 1) {
            document.getElementById('noResults').classList.remove('hidden');
          } else {
            document.getElementById('noResults').classList.add('hidden');
          }
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        console.error('Load posts error:', error);
        alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      } finally {
        isLoading = false;
        document.getElementById('loading').classList.add('hidden');
      }
    }

    // Render posts with new card design
    function renderPosts(posts, clear = false) {
      const container = document.getElementById('postsList');
      
      if (clear) {
        container.innerHTML = '';
      }

      posts.forEach(post => {
        const postCard = document.createElement('div');
        postCard.className = 'post-card';
        postCard.onclick = () => viewPost(post.id);

        postCard.innerHTML = `
          <div class="post-card-header">
            <div class="flex items-center gap-2 mb-2">
              <span class="badge badge-orange">
                ${categoryIcons[post.category]} ${categoryNames[post.category]}
              </span>
              ${post.is_featured ? '<span class="badge badge-green"><i class="fas fa-fire"></i> ì¸ê¸°</span>' : ''}
              <span class="text-xs text-gray" style="margin-left: auto;">${post.timeAgo}</span>
            </div>
            
            <h3 class="post-card-title" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${escapeHtml(post.title)}</h3>
          </div>
          
          <div class="post-card-content" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
            ${escapeHtml(post.preview)}
          </div>
          
          <div class="post-card-footer">
            <div class="flex items-center gap-1">
              <div style="width: 24px; height: 24px; background: var(--gray-300); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">ğŸ‘¤</div>
              <span class="text-sm font-medium">${escapeHtml(post.author_name)}</span>
            </div>
            <div class="flex items-center gap-3" style="margin-left: auto;">
              <div class="post-stats">
                <i class="fas fa-eye"></i>
                <span>${post.views}</span>
              </div>
              <div class="post-stats" style="color: var(--albi-red);">
                <i class="fas fa-heart"></i>
                <span>${post.likes_count}</span>
              </div>
              <div class="post-stats" style="color: var(--albi-blue);">
                <i class="fas fa-comment"></i>
                <span>${post.comments_count}</span>
              </div>
            </div>
          </div>
        `;

        container.appendChild(postCard);
      });
    }

    // ë” ë³´ê¸°
    function loadMorePosts() {
      currentPage++;
      loadPosts();
    }

    // ê²Œì‹œê¸€ ìƒì„¸ ë³´ê¸°
    function viewPost(postId) {
      window.location.href = `/post-detail.html?id=${postId}`;
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
