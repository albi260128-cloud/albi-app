<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>글쓰기 - 알비</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-2xl mx-auto min-h-screen bg-white shadow-xl">
    <!-- 헤더 -->
    <div class="sticky top-0 bg-white z-50 px-4 py-4 border-b flex items-center justify-between">
      <button onclick="confirmCancel()" class="text-gray-600 hover:text-gray-800">
        ← 취소
      </button>
      <h1 class="font-bold text-lg">글쓰기</h1>
      <button onclick="submitPost()" id="submitBtn" class="text-orange-500 font-bold hover:text-orange-600">
        완료
      </button>
    </div>

    <!-- 포인트 안내 -->
    <div class="p-4 bg-green-50 border-b">
      <div class="flex items-center space-x-3">
        <div class="text-3xl">🎁</div>
        <div>
          <h3 class="font-bold text-green-800">글 작성하고 5P 받기!</h3>
          <p class="text-sm text-green-600">많은 공감을 받으면 인기글 보상 20P 추가!</p>
        </div>
      </div>
    </div>

    <!-- 작성 폼 -->
    <div class="p-4 space-y-6">
      <!-- 카테고리 선택 -->
      <div>
        <label class="block font-bold mb-3">카테고리 선택 *</label>
        <div class="grid grid-cols-2 gap-3">
          <label class="cursor-pointer">
            <input type="radio" name="category" value="free" checked class="hidden peer">
            <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 transition">
              <div class="text-3xl mb-1">🗣️</div>
              <div class="font-bold">자유</div>
              <div class="text-xs text-gray-500 mt-1">일상, 고민 등</div>
            </div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="category" value="review" class="hidden peer">
            <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 transition">
              <div class="text-3xl mb-1">📝</div>
              <div class="font-bold">후기</div>
              <div class="text-xs text-gray-500 mt-1">체험, 알바 후기</div>
            </div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="category" value="question" class="hidden peer">
            <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 transition">
              <div class="text-3xl mb-1">❓</div>
              <div class="font-bold">질문</div>
              <div class="text-xs text-gray-500 mt-1">궁금한 점</div>
            </div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="category" value="tip" class="hidden peer">
            <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 transition">
              <div class="text-3xl mb-1">💡</div>
              <div class="font-bold">꿀팁</div>
              <div class="text-xs text-gray-500 mt-1">유용한 정보</div>
            </div>
          </label>
        </div>
      </div>

      <!-- 제목 -->
      <div>
        <label class="block font-bold mb-2">제목 *</label>
        <input type="text" id="title" required maxlength="100"
               class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-orange-500 focus:outline-none text-lg"
               placeholder="제목을 입력하세요 (100자 이내)">
        <p class="text-xs text-gray-500 mt-1" id="titleCount">0 / 100자</p>
      </div>

      <!-- 내용 -->
      <div>
        <label class="block font-bold mb-2">내용 *</label>
        <textarea id="content" required rows="12" maxlength="2000"
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-orange-500 focus:outline-none resize-none"
                  placeholder="내용을 자유롭게 작성해주세요.&#10;&#10;예시:&#10;• 알바 체험 후기&#10;• 면접 꿀팁 공유&#10;• 사장님과의 에피소드&#10;• 알바 관련 고민 상담"></textarea>
        <p class="text-xs text-gray-500 mt-1" id="contentCount">0 / 2000자</p>
      </div>

      <!-- 익명 옵션 -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <label class="flex items-center space-x-3 cursor-pointer">
          <input type="checkbox" id="isAnonymous" class="w-5 h-5 text-orange-500 rounded focus:ring-orange-500">
          <div class="flex-1">
            <span class="font-bold text-blue-900">익명으로 작성하기</span>
            <p class="text-sm text-blue-700">개인정보 보호를 위해 '익명'으로 표시됩니다</p>
          </div>
        </label>
      </div>

      <!-- 작성 규칙 -->
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <h4 class="font-bold text-yellow-900 mb-2 flex items-center">
          <span class="mr-2">📋</span>
          커뮤니티 규칙
        </h4>
        <ul class="text-xs text-yellow-800 space-y-1">
          <li>• 욕설, 비방, 차별적 표현은 삭제됩니다</li>
          <li>• 개인정보(연락처, 주소 등) 공유 금지</li>
          <li>• 광고성 게시글은 제재 대상입니다</li>
          <li>• 서로 존중하는 건전한 소통을 지향해요</li>
        </ul>
      </div>

      <!-- 제출 버튼 -->
      <button type="button" onclick="submitPost()" 
              class="w-full bg-orange-500 text-white py-4 rounded-lg font-bold hover:bg-orange-600 transition text-lg">
        5P 받고 게시글 작성하기
      </button>
    </div>
  </div>

  <script>
    // 글자 수 카운터
    document.getElementById('title').addEventListener('input', function() {
      document.getElementById('titleCount').textContent = `${this.value.length} / 100자`;
    });

    document.getElementById('content').addEventListener('input', function() {
      document.getElementById('contentCount').textContent = `${this.value.length} / 2000자`;
    });

    // 취소 확인
    function confirmCancel() {
      const title = document.getElementById('title').value;
      const content = document.getElementById('content').value;
      
      if (title.trim() || content.trim()) {
        if (confirm('작성 중인 내용이 있습니다. 정말 취소하시겠습니까?')) {
          history.back();
        }
      } else {
        history.back();
      }
    }

    // 게시글 제출
    async function submitPost() {
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const category = document.querySelector('input[name="category"]:checked').value;
      const isAnonymous = document.getElementById('isAnonymous').checked;

      if (!title || !content) {
        alert('제목과 내용을 모두 입력해주세요.');
        return;
      }

      const userInfo = JSON.parse(localStorage.getItem('albi_user_info') || '{}');

      try {
        document.getElementById('submitBtn').textContent = '작성 중...';
        document.getElementById('submitBtn').disabled = true;

        const response = await fetch('/api/community/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: userInfo.id || null,
            authorName: userInfo.name || '알비사용자',
            title,
            content,
            category,
            isAnonymous
          })
        });

        const data = await response.json();

        if (data.success) {
          const pointMessage = data.data.reward > 0 ? `\n${data.data.reward}P가 지급되었습니다!` : '';
          alert(`게시글이 작성되었습니다! 🎉${pointMessage}`);
          window.location.href = `/post-detail.html?id=${data.data.postId}`;
        } else {
          alert('오류: ' + data.error);
        }
      } catch (error) {
        console.error('Submit post error:', error);
        alert('게시글 작성 중 오류가 발생했습니다.');
      } finally {
        document.getElementById('submitBtn').textContent = '완료';
        document.getElementById('submitBtn').disabled = false;
      }
    }
  </script>
</body>
</html>
